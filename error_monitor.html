<!--
 * @Description: 前端异常监控
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>前端异常监控</title>
  <link rel="stylesheet" href="style.css" />
  <script>
    // addEventListener的第三个参数 一定要是true,表示在捕获阶段触发
    // 如果改成false就是冒泡阶段，是获取不到错误事件的
    window.addEventListener('error', function (e) {
      const target = e.target || e.srcElement;
      const isEleError = target instanceof HTMLElement;
      if (!isEleError) {
        console.log('js执行异常---------------------------');
        const {
          message,
          stack
        } = e.error;
        console.log('msg:', stack);
        console.log('stack:', stack);
      } else {
        console.log('资源加载异常---------------------------');
        const {
          type,
          timeStamp,
          target
        } = e;
        const {
          localName,
          outerHTML,
          tagName,
          src
        } = target;
        let sourceUrl = '';
        if (localName === 'link') {
          sourceUrl = target.href;
        } else if (localName === 'script') {
          sourceUrl = target.src;
        }
        console.log(target);

        if (navigator.sendBeacon) {
          navigator.sendBeacon(`http://localhost:3000?data=${encodeURIComponent(sourceUrl)}`);
        } else {
          const img = new Image();
          img.onload = null;
          img.onerror = null;
          img.src = `http://localhost:3000?data=${encodeURIComponent(sourceUrl)}`
        }
      }
    }, true);

    // 测试js运行异常, 执行一个没定义的函数
    testError();

  </script>
</head>

<body>
  <script src="qqq.js"></script>
  <script src="asd.js"></script>
</body>

</html>
